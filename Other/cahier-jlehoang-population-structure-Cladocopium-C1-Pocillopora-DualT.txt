#######################################################################
### Cahier / Notebook to have VCF of _Cladocopium-C1_ reference genome ##
### Author: Julie Lê-Hoang                                           ##
### Date: 06/02/2020                                						  	 ##	
#######################################################################

# 1. Index Reference
bwa index Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta

# 2. Alignment between Cladocopium-C1 reference transcriptome and Pocillopora meandrina - MetaT samples
cat List-Samples-DualG-Pocillopora-Tara-Genoscope.txt | while read a b c; do wa mem -t 6 -M Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta $b $c | samtools view -b -@ 6 -F 4 /dev/stdin -o ${a}_Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-DualT-Tara-DB.aln.bam;done

# 3. Samtools sort, to order reads
ls *.aln.bam | while read a ;do samtools sort -@ 8 -o ${a%.bam}.sort.bam $a --reference Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta; done

# 4. Add read groups :  Make sure "RGSM" portion of code below matches real sample name, else trouble will ensue later!  You can do this using the following command:
ls *.aln.sort.bam | while read a; do picard AddOrReplaceReadGroups I=$a O=${a%.bam}.rg.bam SO=coordinate RGID=id RGLB=library RGPL=platform RGPU=machine RGSM=${a%_Cladocopium-C1-CDS-Durusdinium-D2-transcriptome-Tara-DB.aln.sort.bam}; done

# 5. Filtering bam files : Filter bam files based on mapped region length criteria with BamFilters:
ls *.aln.sort.rg.bam | while read a ;do bamFilters -i 98 -a 80 -r 80 -n 30 -b $a -o ${a%.bam}.98i-80l.bam; done

# 6. Index Bam Files
ls *.sort.rg.98i-*l.bam | while read a ; do samtools index $a;done

# 7. Variant Calling with GATK
[General SNP Calling Pipeline](https://gencore.bio.nyu.edu/variant-calling-pipeline/)
[GATK Best Practices Pipeline](https://gatk.broadinstitute.org/hc/en-us/articles/360035890431-The-logic-of-joint-calling-for-germline-short-variants)

# 8A. Index Reference for use with GATK
picard CreateSequenceDictionary R=Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta O=Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.dict

# 8B. Index Reference for use with samtools
samtools faidx Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta

# 9. Create Realignment Targets : This is the first step in a two-step process of realigning around indels
ls *sort.rg.98i-80l.bam | while read a; do gatk -T RealignerTargetCreator -R Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta -I $a -o ${a%.bam}.realignment_targets.list; done

# 10. Realign Indels : This step performs the realignment around the indels which were identified in the previous step (the ‘realignment targets’)
ls *sort.rg.98i-80l.bam | while read a; do gatk -T IndelRealigner -R Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta -I $a -targetIntervals ${a%.bam}.realignment_targets.list -o ${a%.bam}.realigned_reads.bam; done

# 11. Call Variants on Individual Files (as gVCF in GATK v.3.7.0)
ls *.sort.rg.98i-80l.realigned_reads.bam | while read a; do gatk -T HaplotypeCaller -R Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta -nct 32 -ploidy 1 --emitRefConfidence GVCF -I $a -o ${a%.bam}.g.vcf;done

# 12. Remove samples with _Durusdinium_ or other _Cladocopium_ 

# 13. Merge gVCFs for each Island : Get all files associated to an island and ending with g.vcf and add --variant before them.
samples=$(find . | grep 'I' | sed 's/.\///' | grep -E 'g.vcf$' | sed 's/^/--variant /')

# 14. Then merge :
gatk -T CombineGVCFs -R Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta -o Population-Structure-DualT-CSW-Cladocopium-C1-CDS-and-Durusdinium-D2-Transcriptome-All-Samples-Merged.g.vcf  -V $(echo $samples)

# 15. Perform joint genotyping (i.e., SNP Calling) on Island cohort gVCF files : Get all island cohort files ending with g.vcf for a species and add --variant before them:
samples=$(find . | sed 's/.\///' | grep -E 'g.vcf$' | sed 's/^/--variant /')

# 16. Then perform joint genotyping on these files:
gatk -T GenotypeGVCFs -R Cladocopium-goreaui-C1-CDS-and-Durusdinium-D2-Ahyac-Transcriptome-with-taxonomic-affiliation-Tara-DB-Switch-Filter-90.fasta -o Population-Structure-DualT-CSW-Cladocopium-C1-CDS-and-Durusdinium-D2-Transcriptome-All-Samples-Perform-Genotyping.vcf -V $(echo $samples)

# 17. Removed Durusdinium D2
grep -v 'Durusdinium-D2-Ahyac_TaraDB-' Population-Structure-DualT-CSW-Cladocopium-C1-CDS-and-Durusdinium-D2-Transcriptome-All-Samples-Perform-Genotyping.vcf > Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Perform-Genotyping-Removed-D2.vcf

# 18. Filter VCF to Keep Only Biallelic SNPs
vcftools --gzvcf Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Perform-Genotyping-Removed-D2.vcf.gz --min-alleles 2 --max-alleles 2 --recode --recode-INFO-all --out Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Perform-Genotyping-Removed-D2-Biallelic.vcf

vcftools --gzvcf Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Merged-Removed-D2.vcf.gz --min-alleles 2 --max-alleles 2 --recode --recode-INFO-all --out Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Merged-Removed-D2-Biallelic.vcf

# 19. Compressed results
gzip Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Perform-Genotyping-Removed-D2-Biallelic.vcf

gzip Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Merged-Removed-D2-Biallelic.vcf

# 20. Use bcftools to have some filtering on VCF files
bcftools view -i '%QUAL>=30' Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Perform-Genotyping-Removed-D2-Biallelic.vcf.gz -O z -o Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Perform-Genotyping-Removed-D2-Biallelic-SQ-30.vcf.gz

bcftools view -i '%QUAL>=30' Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Merged-Removed-D2-Biallelic.vcf.gz -O z -o Population-Structure-DualT-CSW-Cladocopium-C1-CDS-All-Samples-Merged-Removed-D2-Biallelic-SQ-30.vcf.gz

#############
## STEP 24 ##
#############
ls *-SQ-30.vcf | while read a; do python /env/cns/proj/TaraPacifique/bin/JulieL/program-jlehoang-SNP-Filtering-NA-Coverage-Biallelic.py $a SNP-Filtering-Coverage-Biallelic-${a%.vcf}-Combined.txt SNP-Filtering-Coverage-Biallelic-${a%.vcf}-Frequency.txt SNP-Filtering-NA-Coverage-Biallelic-${a%.vcf}-Coverage.txt 4 SNP-Filtering-NA-Coverage-Biallelic-${a%.vcf}-Frequency-NA-Filtering.txt; done
